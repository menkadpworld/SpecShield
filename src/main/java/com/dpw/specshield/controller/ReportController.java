package com.dpw.specshield.controller;

import com.dpw.specshield.config.KafkaConfig;
import com.dpw.specshield.dto.TestReportResponse;
import com.dpw.specshield.model.TestExecutionRequest;
import com.dpw.specshield.model.TestSuite;
import com.dpw.specshield.repository.TestExecutionRequestRepository;
import com.dpw.specshield.services.IReportCollector;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.kafka.core.KafkaTemplate;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.Map;

@Slf4j
@RestController
@RequestMapping("/api")
@RequiredArgsConstructor
public class ReportController {

    private final TestExecutionRequestRepository testExecutionRequestRepository;
    private final IReportCollector reportCollector;
    private final KafkaTemplate<String, TestExecutionRequest> kafkaTemplate;
    private final KafkaConfig kafkaConfig;

    @PostMapping("/execute")
    public ResponseEntity<Map<String, Object>> executeTestSuite(@RequestBody TestSuite testSuite) {
        log.info("Received test suite execution request: {}", testSuite.getTestSuiteName());

        // Create and store test execution request
        TestExecutionRequest request = new TestExecutionRequest();
        request.setTestSuiteName(testSuite.getTestSuiteName());
        request.setOriginalId(testSuite.getId());
        request.setBaseUrl(testSuite.getBaseUrl());
        request.setTestSuite(testSuite);
        request.setCreatedAt(LocalDateTime.now());
        request.setStatus("PENDING");

        // Save to database and get auto-generated ID
        TestExecutionRequest savedRequest = testExecutionRequestRepository.save(request);
        String autoGeneratedId = savedRequest.getId();

        // Publish to Kafka
        kafkaTemplate.send(kafkaConfig.getTestExecutionTopic(), autoGeneratedId, savedRequest);
        log.info("Published test execution request to Kafka with ID: {}", autoGeneratedId);

        return ResponseEntity.status(HttpStatus.ACCEPTED)
                .body(Map.of(
                    "message", "Test execution request submitted successfully",
                    "executionId", autoGeneratedId,
                    "status", "PENDING"
                ));
    }

    @GetMapping("/report/{id}")
    public ResponseEntity<TestReportResponse> getReportById(@PathVariable String id) {
        log.info("Received report request for ID: {}", id);

        try {
            TestReportResponse report = reportCollector.getReportById(id);
            return ResponseEntity.ok(report);
        } catch (RuntimeException e) {
            log.error("Report not found: {}", e.getMessage());
            return ResponseEntity.notFound().build();
        }
    }
}
